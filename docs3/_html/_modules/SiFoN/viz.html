
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SiFoN.viz &#8212; SiFoN 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SiFoN 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">SiFoN.viz</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for SiFoN.viz</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">from</span> <span class="nn">plotly.graph_objs</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>

<span class="c1"># TODO: add seqclass_names to github and directly link</span>
<span class="n">seqclass</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../model_data/seqclass-names.txt&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="s2">&quot;#984ef3&quot;</span><span class="p">,</span>
    <span class="s1">&#39;CTCF&#39;</span><span class="p">:</span> <span class="s2">&quot;#fdb462&quot;</span><span class="p">,</span>
    <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="s2">&quot;#ef3b2c&quot;</span><span class="p">,</span>
    <span class="s1">&#39;PC&#39;</span><span class="p">:</span> <span class="s2">&quot;#8abad4&quot;</span><span class="p">,</span>
    <span class="s1">&#39;HET&#39;</span><span class="p">:</span> <span class="s2">&quot;#662506&quot;</span><span class="p">,</span>
    <span class="s1">&#39;TN&#39;</span><span class="p">:</span> <span class="s2">&quot;#fb9a99&quot;</span><span class="p">,</span>
    <span class="s1">&#39;TF&#39;</span><span class="p">:</span> <span class="s2">&quot;#386cb0&quot;</span><span class="p">,</span>
    <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="s2">&quot;#C0C0C0&quot;</span><span class="p">,</span>
    <span class="s1">&#39;NA&#39;</span><span class="p">:</span> <span class="s2">&quot;#000000&quot;</span><span class="p">}</span>

<span class="n">class_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> 
                  <span class="s2">&quot;E1 Stem cell&quot;</span><span class="p">,</span> <span class="s2">&quot;E2 Multi-tissue&quot;</span><span class="p">,</span> <span class="s2">&quot;E3 Brain / Melanocyte&quot;</span><span class="p">,</span> <span class="s2">&quot;E4 Multi-tissue&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;E5 B-cell-like&quot;</span><span class="p">,</span> <span class="s2">&quot;E6 Weak epithelial&quot;</span><span class="p">,</span> <span class="s2">&quot;E7 Monocyte / Macrophage&quot;</span><span class="p">,</span> <span class="s2">&quot;E8 Weak multi-tissue&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;E9 Liver / Intestine&quot;</span><span class="p">,</span> <span class="s2">&quot;E10 Brain&quot;</span><span class="p">,</span> <span class="s2">&quot;E11 T-cell&quot;</span><span class="p">,</span> <span class="s2">&quot;E12 Erythroblast-like&quot;</span><span class="p">],</span>
             <span class="s1">&#39;CTCF&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">27</span><span class="p">,</span> <span class="s2">&quot;CTCF CTCF-Cohesin&quot;</span><span class="p">],</span>
             <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;P Promoter&quot;</span><span class="p">],</span>
             <span class="s1">&#39;PC&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">34</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;PC1 Polycomb / Heterochromatin&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;PC2 Weak Polycomb&quot;</span><span class="p">,</span> <span class="s2">&quot;PC3 Polycomb&quot;</span><span class="p">,</span> <span class="s2">&quot;PC4 Polycomb / Bivalent stem cell Enh&quot;</span><span class="p">],</span>
             <span class="s1">&#39;HET&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> 
                     <span class="s2">&quot;HET1 Heterochromatin&quot;</span><span class="p">,</span> <span class="s2">&quot;HET2 Heterochromatin&quot;</span><span class="p">,</span> <span class="s2">&quot;HET3 Heterochromatin&quot;</span><span class="p">,</span> <span class="s2">&quot;HET4 Heterochromatin&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;HET5 Centromere&quot;</span><span class="p">,</span> <span class="s2">&quot;HET6 Centromere&quot;</span><span class="p">],</span>
             <span class="s1">&#39;TN&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> 
                    <span class="s2">&quot;TN1 Transcription&quot;</span><span class="p">,</span><span class="s2">&quot;TN2 Transcription&quot;</span><span class="p">,</span><span class="s2">&quot;TN3 Transcription&quot;</span><span class="p">,</span><span class="s2">&quot;TN4 Transcription&quot;</span><span class="p">],</span>
             <span class="s1">&#39;TF&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">37</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
                   <span class="s2">&quot;TF1 NANOG / FOXA1&quot;</span><span class="p">,</span> <span class="s2">&quot;TF2 CEBPB&quot;</span><span class="p">,</span> <span class="s2">&quot;TF3 FOXA1 / AR / ESR1&quot;</span><span class="p">,</span> <span class="s2">&quot;TF4 OTX2&quot;</span><span class="p">,</span> <span class="s2">&quot;TF5 AR&quot;</span><span class="p">],</span>
             <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
                   <span class="s2">&quot;L1 Low signal&quot;</span><span class="p">,</span> <span class="s2">&quot;L2 Low signal&quot;</span><span class="p">,</span> <span class="s2">&quot;L3 Low signal&quot;</span><span class="p">,</span> <span class="s2">&quot;L4 Low signal&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;L5 Low signal&quot;</span><span class="p">,</span> <span class="s2">&quot;L6 Low signal&quot;</span><span class="p">,</span> <span class="s2">&quot;L7 Low signal&quot;</span><span class="p">],</span>
             <span class="s1">&#39;NA&#39;</span><span class="p">:[</span><span class="mi">40</span><span class="p">]}</span>

<div class="viewcode-block" id="white_bg"><a class="viewcode-back" href="../../SiFoN.viz.html#SiFoN.viz.white_bg">[docs]</a><span class="k">def</span> <span class="nf">white_bg</span><span class="p">(</span><span class="n">fig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fig :</span>
<span class="sd">        </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">({</span><span class="s2">&quot;plot_bgcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 0, 0)&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;paper_bgcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 0, 0)&quot;</span><span class="p">})</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">gridcolor</span><span class="o">=</span><span class="s2">&quot;#DCDCDC&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">gridcolor</span><span class="o">=</span><span class="s2">&quot;#DCDCDC&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_category"><a class="viewcode-back" href="../../SiFoN.viz.html#SiFoN.viz.get_category">[docs]</a><span class="k">def</span> <span class="nf">get_category</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    index :</span>
<span class="sd">        </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">class_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">class_map</span><span class="p">[</span><span class="n">category</span><span class="p">]:</span> <span class="k">return</span> <span class="n">category</span></div>

<div class="viewcode-block" id="post_processing"><a class="viewcode-back" href="../../SiFoN.viz.html#SiFoN.viz.post_processing">[docs]</a><span class="k">def</span> <span class="nf">post_processing</span><span class="p">(</span><span class="n">scores_max</span><span class="p">,</span> <span class="n">seqclass_names</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;Processes the `scores_max` array to have information necessary for graphing, including sequence class category and color.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scores_max :</span>
<span class="sd">        type scores_max: NumPy Array</span>
<span class="sd">    seqclass_names : list of strings, optional</span>
<span class="sd">        List of names for profiles. Sei sequence classes names or chromatin profile names. Should have length equal to the number of rows in`scores_max`, defaults to Sei sequence class names found in &quot;model_data/seqclass-names.txt&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    type</span>
<span class="sd">        an updated version of `scores_max` that adds the columns “Sequence Index”, “Class” (e..g E, P, TF), “Color” (corresponding to the “Class” column), “Function” (whether a sequence class is associated with repressed or active chromatin). SNPs with a max score in the Low Impact category are also removed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seqclass_names</span> <span class="o">==</span> <span class="p">[]:</span> <span class="n">seqclass_names</span><span class="o">=</span><span class="n">seqclass</span>
    <span class="n">scores_max</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Max Score&quot;</span><span class="p">,</span> <span class="s2">&quot;Sequence Name&quot;</span><span class="p">]</span>
    <span class="n">scores_max</span><span class="p">[</span><span class="s2">&quot;Sequence Index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">seqclass_names</span> <span class="o">==</span> <span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">scores_max</span><span class="p">[</span><span class="s2">&quot;Sequence Name&quot;</span><span class="p">]]</span>
    <span class="n">scores_max</span><span class="p">[</span><span class="s2">&quot;Class&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span><span class="n">get_category</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">scores_max</span><span class="p">[</span><span class="s2">&quot;Sequence Index&quot;</span><span class="p">]]</span>
    <span class="n">scores_max</span><span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span><span class="n">color_map</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">scores_max</span><span class="p">[</span><span class="s2">&quot;Class&quot;</span><span class="p">]]</span>
    <span class="n">scores_max</span><span class="p">[</span><span class="s2">&quot;Function&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Repressed&quot;</span> <span class="k">if</span> <span class="n">cl</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PC&quot;</span><span class="p">,</span> <span class="s2">&quot;HET&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;Active&quot;</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">scores_max</span><span class="p">[</span><span class="s2">&quot;Class&quot;</span><span class="p">]]</span>
    <span class="n">scores_max</span> <span class="o">=</span> <span class="n">scores_max</span><span class="p">[</span><span class="n">scores_max</span><span class="p">[</span><span class="s2">&quot;Class&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;L&quot;</span><span class="p">]</span>
    <span class="n">scores_max</span> <span class="o">=</span> <span class="n">scores_max</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">scores_max</span></div>

<div class="viewcode-block" id="preprocess"><a class="viewcode-back" href="../../SiFoN.viz.html#SiFoN.viz.preprocess">[docs]</a><span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">vcf</span><span class="p">,</span> <span class="n">seqclass_names</span><span class="o">=</span><span class="p">[],</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Processes data so that there is a single row per position representing the alteration with the maximum average score at that position.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : string</span>
<span class="sd">        filename of NumPy sequence class scores</span>
<span class="sd">    vcf : Pandas DataFrame</span>
<span class="sd">        VCF of SNPs of interest, including “Position” column.</span>
<span class="sd">    seqclass_names : list of strings, optional</span>
<span class="sd">        List of names for profiles. Sei sequence classes names or chromatin profile names. Should have length equal to the number of rows in`scores_max`, defaults to Sei sequence class names found in &quot;model_data/seqclass-names.txt&quot;</span>
<span class="sd">    signed : Boolean, optional</span>
<span class="sd">        signifies whether parameters are evaluated by absolute value (False) or not (True), default is True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NumPy Array</span>
<span class="sd">        array of scores, including a single row per position representing the alteration with the maximum average score</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seqclass_names</span> <span class="o">==</span> <span class="p">[]:</span> <span class="n">seqclass_names</span><span class="o">=</span><span class="n">seqclass</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">seqclass_names</span><span class="p">)</span>
    <span class="n">scores</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">vcf</span><span class="p">[</span><span class="s2">&quot;Position&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">signed</span><span class="p">:</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;mergesort&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># sort by position</span>
        <span class="n">scores_min</span><span class="p">,</span> <span class="n">scores_max</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="n">scores</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> 
        <span class="n">scores_min</span><span class="p">,</span> <span class="n">scores_max</span> <span class="o">=</span> <span class="n">scores_min</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="mi">3</span><span class="p">,</span> <span class="p">:],</span> <span class="n">scores_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">scores_min</span><span class="p">,</span> <span class="n">scores_max</span> <span class="o">=</span> <span class="n">scores_min</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:],</span> <span class="n">scores_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores_max</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">scores_max</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">scores_min</span><span class="p">),</span> <span class="n">scores_min</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;mergesort&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># sort by position</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="c1"># find maximum prediction from in silico mut</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span>
    <span class="n">scores</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">scores</span></div>

<div class="viewcode-block" id="find_max"><a class="viewcode-back" href="../../SiFoN.viz.html#SiFoN.viz.find_max">[docs]</a><span class="k">def</span> <span class="nf">find_max</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seqclass_names</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;Takes the (abs) max sequence class score for each position/alteration.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scores : NumPy array</span>
<span class="sd">        Takes the (abs) max sequence class score for each position/alteration. Should run the `preprocessing` function first. The output array has columns [“Max Score&quot;, &quot;Sequence Name&quot;] corresponding the (abs) max score and the corresponding sequence class. This array is then past through the `post_processing` function.</span>
<span class="sd">    signed : Boolean, optional</span>
<span class="sd">        signifies whether parameters are evaluated by absolute value (False) or not (True). This should be set to the same value as in the `preprocessing` function, default is True</span>
<span class="sd">    seqclass_names : list of strings, optional</span>
<span class="sd">        List of names for profiles. Sei sequence classes names or chromatin profile names. Should have length equal to the number of rows in`scores_max`, defaults to Sei sequence class names found in &quot;model_data/seqclass-names.txt&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Pandas DataFrame</span>
<span class="sd">        Dataframe with one prediction per alteration, corresponding the maximum sequence class score and its corresponding sequence class name. Metadata used for graphing is also included in the dataframe.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seqclass_names</span> <span class="o">==</span> <span class="p">[]:</span> <span class="n">seqclass_names</span><span class="o">=</span><span class="n">seqclass</span>
    <span class="k">if</span> <span class="n">signed</span><span class="p">:</span>
        <span class="n">scores_max</span><span class="p">,</span> <span class="n">scores_min</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(),</span> <span class="n">scores</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
        <span class="n">max_idx</span><span class="p">,</span> <span class="n">min_idx</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(),</span> <span class="n">scores</span><span class="o">.</span><span class="n">idxmin</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
        <span class="n">scores_max</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">scores_max</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">scores_max</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">scores_min</span><span class="p">),</span> <span class="n">scores_min</span><span class="p">),</span> 
                        <span class="n">max_idx</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">scores_max</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">scores_min</span><span class="p">),</span> <span class="n">min_idx</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scores_max</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(),</span> <span class="n">scores</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">scores_max</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Max Score&quot;</span><span class="p">,</span> <span class="s2">&quot;Sequence Name&quot;</span><span class="p">]</span>
    <span class="n">scores_max</span> <span class="o">=</span> <span class="n">post_processing</span><span class="p">(</span><span class="n">scores_max</span><span class="p">,</span> <span class="n">seqclass_names</span><span class="o">=</span><span class="n">seqclass_names</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scores_max</span></div>

<div class="viewcode-block" id="find_max_by_category"><a class="viewcode-back" href="../../SiFoN.viz.html#SiFoN.viz.find_max_by_category">[docs]</a><span class="k">def</span> <span class="nf">find_max_by_category</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seqclass_names</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;Takes the (abs) max sequence class score within a category for each position/alteration.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scores : NumPy array</span>
<span class="sd">        Takes the (abs) max sequence class score within a category for each position/alteration. Should run the `preprocessing` function first. The output array has columns [“Max Score&quot;, &quot;Sequence Name&quot;] corresponding the (abs) max score and the corresponding sequence class. This array is then past through the `post_processing` function.</span>
<span class="sd">    signed : Boolean, optional</span>
<span class="sd">        signifies whether parameters are evaluated by absolute value (False) or not (True). This should be set to the same value as in the `preprocessing` function, default is True</span>
<span class="sd">    seqclass_names : list of strings, optional</span>
<span class="sd">        List of names for profiles. Sei sequence classes names or chromatin profile names. Should have length equal to the number of rows in`scores_max`, defaults to Sei sequence class names found in &quot;model_data/seqclass-names.txt&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Pandas DataFrame</span>
<span class="sd">        Dataframe with seven predictions per alteration, corresponding to the maximum score within each of the seven sequence classes (excluding L and NA). Metadata used for graphing is also included in the dataframe.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seqclass_names</span> <span class="o">==</span> <span class="p">[]:</span> <span class="n">seqclass_names</span><span class="o">=</span><span class="n">seqclass</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">color_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;NA&quot;</span> <span class="p">:</span> <span class="k">continue</span>
        <span class="n">good_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="ow">in</span> <span class="n">class_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">col_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">good_col</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">col_indices</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span>
            <span class="n">max_by_cat</span> <span class="o">=</span> <span class="n">find_max</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">signed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_by_cat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">max_by_cat</span><span class="p">,</span> <span class="n">find_max</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">signed</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">max_by_cat</span></div>

<div class="viewcode-block" id="plot_max"><a class="viewcode-back" href="../../SiFoN.viz.html#SiFoN.viz.plot_max">[docs]</a><span class="k">def</span> <span class="nf">plot_max</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">scores_prune</span><span class="p">,</span> <span class="n">TSS</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;Plots the maximum Sei classes along a genomic sequence.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : string</span>
<span class="sd">        name of file that figure will be saved as.</span>
<span class="sd">    scores_prune : Pandas DataFrame</span>
<span class="sd">        Dataframe that denotes the maximum Sei sequence classes along some region of the genome. Must contain the following columns: [&quot;Max Score&quot;, &quot;Class&quot;, &quot;Position&quot;, &quot;Sequence Name&quot;]. This is generated as output from the `find_max` and `find_max_by_category` functions.</span>
<span class="sd">    TSS : Dict[str, list[int, int]]</span>
<span class="sd">        Specifies regions of the genome to annotate in the figure. The first element of the dictionary (str) will be the name or label of the annotation which will appear in the legend. The list of ints will denote the end points of the region to be annotated.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;Max Score&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span>   
    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">scores_prune</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Position&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
           <span class="n">hover_data</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Position&quot;</span><span class="p">,</span> <span class="s2">&quot;Max Score&quot;</span><span class="p">,</span> <span class="s2">&quot;Sequence Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">],</span>
                    <span class="n">color_discrete_sequence</span> <span class="o">=</span> <span class="n">scores_prune</span><span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">TSS</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">TSS</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span> 
    <span class="n">bot</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">scores_prune</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="p">(</span><span class="n">tss_desc</span><span class="p">,</span> <span class="n">tss_pos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TSS</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">num</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">bot</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">tss_pos</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines+text&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">tss_desc</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">7</span><span class="p">)))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;opacity&#39;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">})</span>
    <span class="n">white_bg</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">write_html</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="plot_max_from_scores"><a class="viewcode-back" href="../../SiFoN.viz.html#SiFoN.viz.plot_max_from_scores">[docs]</a><span class="k">def</span> <span class="nf">plot_max_from_scores</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">vcf</span><span class="p">,</span> <span class="n">TSS</span><span class="o">=</span><span class="p">{},</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_by</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seqclass_names</span><span class="o">=</span><span class="p">[]):</span> 
    <span class="sd">&quot;&quot;&quot;Preprocesses Sei prediction data, finds the maximum, and then plots the results. Runs `preprocessing`, `find_max` or `find_max_by_category`, and then `plot_max`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : string</span>
<span class="sd">        name of file that figure will be saved as.</span>
<span class="sd">    file : string</span>
<span class="sd">        filename of NumPy sequence class scores</span>
<span class="sd">    vcf : Pandas DataFrame</span>
<span class="sd">        VCF of SNPs of interest, including “Position” column.</span>
<span class="sd">    TSS : Dict[str, list[int, int]], optional</span>
<span class="sd">        Specifies regions of the genome to annotate in the figure. The first element of the dictionary (str) will be the name or label of the annotation which will appear in the legend. The list of ints will denote the end points of the region to be annotated, defaults to an empty dictionary</span>
<span class="sd">    signed : Boolean, optional</span>
<span class="sd">        signifies whether parameters are evaluated by absolute value (False) or not (True). This should be set to the same value as in the `preprocessing` function, default is True</span>
<span class="sd">    plot_by : string, optional</span>
<span class="sd">        Specifies whether the maximum of sequence class is plotted (&quot;class&quot;) or the maximim within each sequence category (&quot;category). Should be either &quot;class&quot; (calls `find_max`) or &quot;category&quot; (calls `find_max_by_category`), defaults to &quot;class&quot;</span>
<span class="sd">    pre : Boolean, optional</span>
<span class="sd">        determines whether to run preprocessing or not. If there is already only one alteration per position, then this should be set to False, default is False.</span>
<span class="sd">    seqclass_names : list of strings, optional</span>
<span class="sd">        List of names for profiles. Sei sequence classes names or chromatin profile names. Should have length equal to the number of rows in`scores_max`, defaults to Sei sequence class names found in &quot;model_data/seqclass-names.txt&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seqclass_names</span> <span class="o">==</span> <span class="p">[]:</span> <span class="n">seqclass_names</span><span class="o">=</span><span class="n">seqclass</span>
    <span class="k">if</span> <span class="n">pre</span><span class="p">:</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">vcf</span><span class="p">,</span> <span class="n">seqclass_names</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="n">signed</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span>
        <span class="n">max_scores</span> <span class="o">=</span> <span class="n">find_max_by_category</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">&quot;class&quot;</span><span class="p">:</span>
        <span class="n">max_scores</span> <span class="o">=</span> <span class="n">find_max</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="n">signed</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span><span class="p">(</span><span class="s2">&quot;Error: `plot_by` should be `class` or `category`&quot;</span><span class="p">)</span>
    <span class="n">plot_max</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">max_scores</span><span class="p">,</span> <span class="n">TSS</span><span class="o">=</span><span class="n">TSS</span><span class="p">)</span></div>

        
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SiFoN 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">SiFoN.viz</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Briana Macedo.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>